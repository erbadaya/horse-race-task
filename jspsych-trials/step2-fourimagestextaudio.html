<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.2"></script>
    <script src="./create-new-plugin/plugin-audio-survey-input-response.js"></script>

    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    var timeline = [];
    
    // we will use this to randomly put the pictures given the group
    var horses = ['apocalypse', 'firewalker', 'blackblade', 'silversky']

    function shuffle(array) {
        let currentIndex = array.length,  randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex > 0) {

          // Pick a remaining element.
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          // And swap it with the current element.
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
        }

        return array;
    }

    shuffle(horses);

    // need this for the time being until we include all consent forms etc.
    var before_audio = {
        type: jsPsychHtmlButtonResponse,
        stimulus: 'Click to start',
        choices: ['OK']
    }

    // issue with this one: any response will jump to the next one. using user input in the prompt doesn't save the responses. 
    // so still the best way to go is with survey-html
    // either modify the plug in so it can also take sound
    // but the next issue is to prevent participants from clicking the button until all audios have been listened to (kenny smith's student's modified plug)

    var bet = {
        type: jsPsychAudioSurveyInputResponse,
        stimulus: "critical_apocalypse_native_disfluent.mp3",
        html: `
            <div class="row">
              <div class='column'>
                <img src="`+ horses[0] +`.jpg"/>
                <img src="`+ horses[1] +`.jpg"/>
                <p> Place your bet on `+ horses[0] +` <input name="`+ horses[0] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[1] +`<input name="`+ horses[1] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
              <div class='column'>
                <img src="`+ horses[2] +`.jpg"/>
                <img src="`+ horses[3] +`.jpg"/>
                <p> Place your bet on `+ horses[2] +` <input name="`+ horses[2] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[3] +`<input name="`+ horses[3] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
            </div>`,
        response_allowed_while_playing: false,
        on_finish: function(data) {
          tot = 0
          tot += parseFloat(data.response.apocalypse);
          tot += parseFloat(data.response.blackblade);
          tot += parseFloat(data.response.silversky);
          tot += parseFloat(data.response.firewalker);
          console.log(tot)
          }
    }

    var if_feedback = {
      type: jsPsychSurveyHtmlForm,
      preamble: function(){
        var horse0_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[0]];
        var horse1_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[1]];
        var horse2_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[2]];
        var horse3_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[3]];
        var text = '<p> You bet more than your allocated 100 pounds. Please, re-distribute your bets. You allocated ' + horse0_bet + ' on ' + horses[0] + 
          ', ' + horse1_bet +' on ' + horses[1] +', '+ horse2_bet +' on ' + horses[2] + ' and ' + horse3_bet +' on ' + horses[3] + '.</p>'
        return text
      },
      html: `
            <div class="row">
              <div class='column'>
                <img src="`+ horses[0] +`.jpg"/>
                <img src="`+ horses[1] +`.jpg"/>
                <p> Place your bet on `+ horses[0] +` <input name="`+ horses[0] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[1] +`<input name="`+ horses[1] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
              <div class='column'>
                <img src="`+ horses[2] +`.jpg"/>
                <img src="`+ horses[3] +`.jpg"/>
                <p> Place your bet on `+ horses[2] +` <input name="`+ horses[2] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[3] +`<input name="`+ horses[3] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
            </div>`,
        on_finish: function(data) {
          tot = 0
          tot += parseFloat(data.response.apocalypse_fix);
          tot += parseFloat(data.response.blackblade_fix);
          tot += parseFloat(data.response.silversky_fix);
          tot += parseFloat(data.response.firewalker_fix);
          console.log(tot)
          }
    }

    var if_node = {
      timeline: [if_feedback],
      loop_function: function() {
        if(tot < 101){
          return false
        } else {
          return true
        }
      }

    }



    jsPsych.run([before_audio, bet, if_node]);
  </script>
</html>