<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey@0.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.2"></script>
    <script src="./create-new-plugin/plugin-audio-survey-input-response.js"></script>
    <script src="./dist/plugin-instructions.js"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="./dist/jspsych.css">
    <script src="jatos.js"></script>
  </head>
  <body></body>
  <script>
    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        var subjectNumber = jatos.workerId;
        var filedata = jsPsych.data.get().ignore('stimulus').csv();
        var filename = "ID_"+subjectNumber+jatos.urlQueryParameters.PROLIFIC_PID+".csv";
        jatos.submitResultData(filedata)
        jatos.uploadResultFile(filedata, filename)
      }
    });

    var timeline = [];
    
    // need this for the time being until we include all consent forms etc.
    var before_audio = {
        type: jsPsychHtmlButtonResponse,
        stimulus: 'Click to start',
        choices: ['OK']
    }

    function shuffle(array) {
        let currentIndex = array.length,  randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex > 0) {

          // Pick a remaining element.
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          // And swap it with the current element.
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
        }

        return array;
    }

    // presentation of stimuli
    // random allocation by group is done via JATOS
    // so each code here has a different set of stimuli, one per list

    var list1 = [
        {descriptions: 'sounds/critical_apocalypse_native_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '1', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_native_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '1', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '1', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '1', speaker: 'nonnative', delivery: 'disfluent'}
    ];

    var list2 = [
        {descriptions: 'sounds/critical_apocalypse_native_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '2', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_native_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '2', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '2', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '2', speaker: 'nonnative', delivery: 'fluent'}
    ];

    var list3 = [
        {descriptions: 'sounds/critical_apocalypse_native_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '3', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '3', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_native_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '3', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '3', speaker: 'nonnative', delivery: 'disfluent'}
    ];

    var list4 = [
        {descriptions: 'sounds/critical_apocalypse_native_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '4', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '4', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_native_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '4', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '4', speaker: 'nonnative', delivery: 'fluent'}
    ];

    var list5 = [
        {descriptions: 'sounds/critical_apocalypse_native_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '5', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '5', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '5', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_native_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '5', speaker: 'native', delivery: 'disfluent'}
    ];

    var list6 = [
        {descriptions: 'sounds/critical_apocalypse_native_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '6', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '6', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '6', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_native_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '6', speaker: 'native', delivery: 'disfluent'}
    ];

    var list7 = [
        {descriptions: 'sounds/critical_apocalypse_native_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '7', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_native_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '7', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '7', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '7', speaker: 'nonnative', delivery: 'disfluent'}
    ];

    var list8 = [
        {descriptions: 'sounds/critical_apocalypse_native_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '8', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_native_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '8', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '8', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '8', speaker: 'nonnative', delivery: 'fluent'}
    ];

    var list9 = [
        {descriptions: 'sounds/critical_apocalypse_native_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '9', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '9', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_native_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '9', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '9', speaker: 'nonnative', delivery: 'disfluent'}
    ];

    var list10 = [
        {descriptions: 'sounds/critical_apocalypse_native_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '10', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '10', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_native_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '10', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '10', speaker: 'nonnative', delivery: 'fluent'}
    ];

    var list11 = [
        {descriptions: 'sounds/critical_apocalypse_native_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '11', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '11', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '11', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_native_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '11', speaker: 'native', delivery: 'fluent'}
    ];

    var list12 = [
        {descriptions: 'sounds/critical_apocalypse_native_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '12', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '12', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '12', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_native_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '12', speaker: 'native', delivery: 'fluent'}
    ];

    var list13 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '13', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '13', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_native_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '13', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_native_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '13', speaker: 'native', delivery: 'disfluent'}
    ];

    var list14 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '14', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '14', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_native_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '14', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_native_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '14', speaker: 'native', delivery: 'fluent'}
    ];

    var list15 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '15', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_native_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '15', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '15', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_native_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '15', speaker: 'native', delivery: 'disfluent'}
    ];

    var list16 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '16', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_native_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '16', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '16', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_native_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '16', speaker: 'native', delivery: 'fluent'}
    ];

    var list17 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '17', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_native_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '17', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_native_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '17', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '17', speaker: 'nonnative', delivery: 'disfluent'}
    ];

    var list18 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_fluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '18', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_firewalker_native_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '18', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_native_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '18', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '18', speaker: 'nonnative', delivery: 'disfluent'}
    ];

    var list19 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '19', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '19', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_native_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '19', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_native_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '19', speaker: 'native', delivery: 'disfluent'}
    ];

    var list20 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '20', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_nonnative_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '20', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_native_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '20', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_native_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '20', speaker: 'native', delivery: 'fluent'}
    ];

    var list21 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '21', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_native_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '21', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '21', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_native_disfluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '21', speaker: 'native', delivery: 'disfluent'}
    ];

    var list22 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '22', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_native_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '22', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_nonnative_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '22', speaker: 'nonnative', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_native_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '22', speaker: 'native', delivery: 'fluent'}
    ];

    var list23 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '23', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_native_fluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '23', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_blackblade_native_disfluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '23', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '23', speaker: 'nonnative', delivery: 'fluent'}
    ];

    var list24 = [
        {descriptions: 'sounds/critical_apocalypse_nonnative_disfluent.mp3', horses: 'apocalypse', text: 'Apocalypse', group: '24', speaker: 'nonnative', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_firewalker_native_disfluent.mp3', horses: 'firewalker', text: 'Fire Walker', group: '24', speaker: 'native', delivery: 'disfluent'},
        {descriptions: 'sounds/critical_blackblade_native_fluent.mp3', horses: 'blackblade', text: 'Black Blade', group: '24', speaker: 'native', delivery: 'fluent'},
        {descriptions: 'sounds/critical_silversky_nonnative_fluent.mp3', horses: 'silversky', text: 'Silver Sky', group: '24', speaker: 'nonnative', delivery: 'fluent'}
    ]

    function shuffle(array) {
        let currentIndex = array.length,  randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex > 0) {

          // Pick a remaining element.
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          // And swap it with the current element.
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
        }

        return array;
    };

    var condition_assignment = shuffle([list1, list2, list3, list4, list5, list6, list7, list8, list9, list10, list11, list12,
                                                                                list13, list14, list15, list16, list17, list18, list19, list20, list21, list22, list23, list24])[0];
    shuffle(condition_assignment);

    var preload = {
      type: jsPsychPreload,
      auto_preload: true,
    };
    // play four audios, and let people answer once the last audio has finished playing. NB all responses are in survey form in javascript and the code is that they can edit their old bets as they listen to new descriptions
    // we have modified the AudioButtonResponse by combining it with the SurveyHtlmForm 

    // if we do this the only issue is that we force participants to re-write unless we write the code
    // We do that by 1) only forcing an answer in the horse being described in each trial, the code works so that it will always show the latest value input 
    var bet_firsthorse = {
        type: jsPsychAudioSurveyInputResponse,
        stimulus: condition_assignment[0].descriptions, 
        html: `
        <div class="container">
                <div class="item">
                  <img  class="picture" src="img/`+ condition_assignment[0].horses +`_red.jpg">
                  <p> Place your bet on `+ condition_assignment[0].text +` <input name="`+ condition_assignment[0].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/> </p>
                </div>
                <div class="item">
                  <img class="picture" src="img/`+ condition_assignment[1].horses +`.jpg"/>
                  <p> You will listen this horse's description next.</p>
                </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[2].horses +`.jpg"/>
                <p> Wait for its turn.</p>
              </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[3].horses +`.jpg"/>
                <p> Wait for its turn.</p>
            </div>
          </div>`,
        response_allowed_while_playing: false,
        data: {
          type: 'firstbet', // for data filtering
          overbet: 'no',
          speaker: condition_assignment[0].speaker,
          delivery: condition_assignment[0].delivery,
          list: condition_assignment[0].group,
          horse: condition_assignment[0].horses
        }
    }

    var bet_secondhorse = {
        type: jsPsychAudioSurveyInputResponse,
        stimulus: condition_assignment[1].descriptions, 
        html: function(data){
          var bet_horse0 = jsPsych.data.get().trials[1].response[condition_assignment[0].horses];
          var text = `
          <div class="container">
                <div class="item">
                  <img  class="picture" src="img/`+ condition_assignment[0].horses +`.jpg">
                  <p> Money bet on ` + condition_assignment[0].text + `: `+  bet_horse0 + `. </p> <p>If you wish to modify your bet, please enter the new bet here: <input name="`+ condition_assignment[0].horses +`" type="number"  max="100" step=".01" min="0" id="bet"/></p>
                </div>
                <div class="item">
                  <img class="picture" src="img/`+ condition_assignment[1].horses +`_red.jpg"/>
                  <p> Place your bet on `+ condition_assignment[1].text +`<input name="`+ condition_assignment[1].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
                </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[2].horses +`.jpg"/>
                <p> You will listen this horse's description next.</p>
              </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[3].horses +`.jpg"/>
                <p> Wait for its turn.</p>
            </div>
          </div>`
            return text
          },
        response_allowed_while_playing: false,
        data: {
          type: 'secondbet', // for data filtering
          overbet: 'no',
          speaker: condition_assignment[1].speaker,
          delivery: condition_assignment[1].delivery,
          list: condition_assignment[1].group,
          horse: condition_assignment[1].horses
        }
    }

    var bet_thirdhorse = {
        type: jsPsychAudioSurveyInputResponse,
        stimulus: condition_assignment[2].descriptions, 
        html: function(){
          var bet_horse0 = jsPsych.data.get().trials[2].response[condition_assignment[0].horses];
          if(bet_horse0 == ""){bet_horse0 = jsPsych.data.get().trials[1].response[condition_assignment[0].horses]}
          var bet_horse1 = jsPsych.data.get().trials[2].response[condition_assignment[1].horses];
          var text = `
          <div class="container">
                <div class="item">
                  <img  class="picture" src="img/`+ condition_assignment[0].horses +`.jpg">
                  <p> Money bet on ` + condition_assignment[0].text + `: `+  bet_horse0 + `. </p> <p>If you wish to modify your bet, please enter the new bet here: <input name="`+ condition_assignment[0].horses +`" type="number"  max="100" step=".01" min="0" id="bet"/></p>
                </div>
                <div class="item">
                  <img class="picture" src="img/`+ condition_assignment[1].horses +`.jpg"/>
                  <p> Money bet on ` + condition_assignment[1].text + `: `+  bet_horse1 + `. </p> <p>If you wish to modify your bet, please enter the new bet here: <input name="`+ condition_assignment[1].horses +`" type="number"  max="100" step=".01" min="0" id="bet"/></p>
                </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[2].horses +`_red.jpg"/>
                <p> Place your bet on `+ condition_assignment[2].text +` <input name="`+ condition_assignment[2].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/> </p>
              </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[3].horses +`.jpg"/>
                <p> You will listen this horse's description next.</p>
            </div>
          </div>`
            return text
          },
        response_allowed_while_playing: false,
        data: {
          type: 'thirdbet', // for data filtering
          overbet: 'no',
          speaker: condition_assignment[2].speaker,
          delivery: condition_assignment[2].delivery,
          list: condition_assignment[2].group,
          horse: condition_assignment[2].horses
        }
    }

    var bet_forthhorse = {
        type: jsPsychAudioSurveyInputResponse,
        stimulus: condition_assignment[3].descriptions, 
        html: function(){
          var bet_horse0 = jsPsych.data.get().trials[3].response[condition_assignment[0].horses];
          if(bet_horse0 == ""){bet_horse0 = jsPsych.data.get().trials[2].response[condition_assignment[0].horses]}
          if(bet_horse0 == ""){bet_horse0 = jsPsych.data.get().trials[1].response[condition_assignment[0].horses]}
          var bet_horse1 = jsPsych.data.get().trials[3].response[condition_assignment[1].horses];
          if(bet_horse1 == ""){bet_horse1 = jsPsych.data.get().trials[2].response[condition_assignment[1].horses]}
          var bet_horse2 = jsPsych.data.get().trials[3].response[condition_assignment[2].horses];
          var text = `
          <div class="container">
                <div class="item">
                  <img  class="picture" src="img/`+ condition_assignment[0].horses +`.jpg">
                  <p> Money bet on ` + condition_assignment[0].text + `: `+  bet_horse0 + `. </p> <p>If you wish to modify your bet, please enter the new bet here: <input name="`+ condition_assignment[0].horses +`" type="number"  max="100" step=".01" min="0" id="bet"/></p>
                </div>
                <div class="item">
                  <img class="picture" src="img/`+ condition_assignment[1].horses +`.jpg"/>
                  <p> Money bet on ` + condition_assignment[1].text + `: `+  bet_horse1 + `. </p> <p>If you wish to modify your bet, please enter the new bet here: <input name="`+ condition_assignment[1].horses +`" type="number"  max="100" step=".01" min="0" id="bet"/></p>
                </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[2].horses +`.jpg"/>
                <p> PMoney bet on ` + condition_assignment[2].text + `: `+  bet_horse2 + `. </p> <p>If you wish to modify your bet, please enter the new bet here: <input name="`+ condition_assignment[2].horses +`" type="number"  max="100" step=".01" min="0" id="bet"/></p>
              </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[3].horses +`_red.jpg"/>
                <p> Place your bet on `+ condition_assignment[3].text +`<input name="`+ condition_assignment[3].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
            </div>
          </div>`
            return text
          },
        response_allowed_while_playing: false,
        data: {
          type: 'forthbet', // for data filtering
          overbet: 'no',
          speaker: condition_assignment[3].speaker,
          delivery: condition_assignment[3].delivery,
          list: condition_assignment[3].group,
          horse: condition_assignment[3].horses
        },
        on_finish: function(data) {
          var bet_horse0 = jsPsych.data.get().trials[3].response[condition_assignment[0].horses];
          if(bet_horse0 == ""){bet_horse0 = jsPsych.data.get().trials[2].response[condition_assignment[0].horses]}
          if(bet_horse0 == ""){bet_horse0 = jsPsych.data.get().trials[1].response[condition_assignment[0].horses]}
          var bet_horse1 = jsPsych.data.get().trials[3].response[condition_assignment[1].horses];
          if(bet_horse1 == ""){bet_horse1 = jsPsych.data.get().trials[2].response[condition_assignment[1].horses]}
          var bet_horse2 = jsPsych.data.get().trials[3].response[condition_assignment[2].horses];
          tot = 0
          tot += parseFloat(bet_horse0);
          tot += parseFloat(bet_horse1);
          tot += parseFloat(bet_horse2);
          tot += parseFloat(data.response[condition_assignment[3].horses])
          jsPsych.data.addProperties({total_bet: tot});
          jsPsych.data.addProperties({fixed_bet_over100: 0}); 
          }
    }

    // If participants bet more than 100 pounds, ask them again until their bet is lower than 100. In this rounds, they cannot listen to the audio.

    var if_feedback = {
      type: jsPsychSurveyHtmlForm,
      preamble: function(){
        var horse0_bet = jsPsych.data.getLastTrialData().trials[0].response[condition_assignment[0].horses];
        if(horse0_bet == ""){horse0_bet = jsPsych.data.get().trials[3].response[condition_assignment[0].horses]}
        if(horse0_bet == ""){horse0_bet = jsPsych.data.get().trials[2].response[condition_assignment[0].horses]}
        if(horse0_bet == ""){horse0_bet = jsPsych.data.get().trials[1].response[condition_assignment[0].horses]}
        var horse1_bet = jsPsych.data.getLastTrialData().trials[0].response[condition_assignment[1].horses];
        if(horse0_bet == ""){horse0_bet = jsPsych.data.get().trials[3].response[condition_assignment[1].horses]}
        if(horse1_bet == ""){horse1_bet = jsPsych.data.get().trials[2].response[condition_assignment[1].horses]}
        var horse2_bet = jsPsych.data.getLastTrialData().trials[0].response[condition_assignment[2].horses];
        if(horse2_bet == ""){horse2_bet = jsPsych.data.get().trials[3].response[condition_assignment[2].horses]}
        var horse3_bet = jsPsych.data.getLastTrialData().trials[0].response[condition_assignment[3].horses];
        var text = '<p> You bet more than your allocated 100 pounds. Please, re-distribute your bets. You allocated ' + horse0_bet + ' on ' + condition_assignment[0].text + 
          ', ' + horse1_bet +' on ' + condition_assignment[1].text +', '+ horse2_bet +' on ' + condition_assignment[2].text + ' and ' + horse3_bet +' on ' + condition_assignment[3].text + '.</p>'
        return text
      },
      html: `
          <div class="container">
                <div class="item">
                  <img  class="picture" src="img/`+ condition_assignment[0].horses +`.jpg">
                  <p> Place your bet on `+ condition_assignment[0].text +`<input name="`+ condition_assignment[0].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
                </div>
                <div class="item">
                  <img class="picture" src="img/`+ condition_assignment[1].horses +`.jpg"/>
                  <p> Place your bet on `+ condition_assignment[1].text +`<input name="`+ condition_assignment[1].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
                </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[2].horses +`.jpg"/>
                <p> Place your bet on `+ condition_assignment[2].text +`<input name="`+ condition_assignment[2].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
            <div class="item">
                <img class="picture" src="img/`+ condition_assignment[3].horses +`_red.jpg"/>
                <p> Place your bet on `+ condition_assignment[3].text +`<input name="`+ condition_assignment[3].horses +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
            </div>
          </div>`,
          data: {
            type: 'overbet', // for data filtering
            overbet: 'yes'
        },
          on_finish: function(data) {
          tot_fix = 0
          tot_fix += parseFloat(data.response.apocalypse);
          tot_fix += parseFloat(data.response.blackblade);
          tot_fix += parseFloat(data.response.silversky);
          tot_fix += parseFloat(data.response.firewalker);
          jsPsych.data.addProperties({fixed_bet_over100: tot_fix});
          jsPsych.data.addProperties({total_bet: 0});
          }
    }

    var loop_feedback = {
      timeline: [if_feedback],
      loop_function: function() {
        if(jsPsych.data.getLastTrialData().trials[0].fixed_bet_over100 < 101 && jsPsych.data.getLastTrialData().trials[0].total_bet < 101){
          return false
        } else {
          return true
        }
      }
    };

    var loop_conditional_feedback = {
      timeline: [loop_feedback],
      conditional_function: function() {
        if(jsPsych.data.getLastTrialData().trials[0].fixed_bet_over100 < 101 && jsPsych.data.getLastTrialData().trials[0].total_bet < 101){
          return false
        } else {
          return true
        }
      }
    };


    jatos.onLoad(() => {
    jsPsych.run([preload, bet_firsthorse, bet_secondhorse, bet_thirdhorse, bet_forthhorse, loop_conditional_feedback])
  });
  </script>
</html>