<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.2"></script>
    <script src="./create-new-plugin/plugin-audio-survey-input-response.js"></script>
    <script src="./dist/plugin-instructions.js"></script>

    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body></body>
  <script>
    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    var timeline = [];
    
    // we will use this to randomly put the pictures given the group

    var horses = ['apocalypse', 'firewalker', 'blackblade', 'silversky'];
    var descriptions = ["critical_apocalypse_native_disfluent.mp3","critical_firewalker_nonnative_disfluent.mp3"];

    function shuffle(array) {
        let currentIndex = array.length,  randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex > 0) {

          // Pick a remaining element.
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          // And swap it with the current element.
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
        }

        return array;
    }

    shuffle(horses);
    shuffle(descriptions);

    var welcome_screen = {
      type: jsPsychInstructions,
      pages: [
        'In this experiment, you will listen to a series of speaker providing descriptions about horses. Because the experiment relies on you listening to audios, <b> it works best if you are in a quiet place, and wear headphones. </b> If you don\'t have headphones, earbuds or decent computer speakers would be helpful. <br> Please decide on what you are doing to use, and check that your sound is working properly, before continuing to the next page.'
      ],
      show_clickable_nav: true
    };

    // check that headphones are on
    var check_headphones = {
        type: jsPsychAudioButtonResponse,
        stimulus: 'adjust_volume.mp3',
        prompt: 'Please adjust your volume and follow the audio instruction. You will only hear this audio once.',
        choices: ['T', 'M', 'Q', 'H', 'X', 'W', 'S', 'P'],
        response_allowed_while_playing: false,
        on_finish: function(data) {
            if(data.response == 2){
              data.correct = true; // not working atm \_o.o_/
            } else {
              data.correct = false;
            }
          }
    };


    // introduce speakers

    var introduction_speakers = {
      type: jsPsychInstructions,
      pages: [
        'We have received information from the UK and Italy\'s leading horse racing tipsters, Lauren Waterstone and Marila Fiammetta, about the upcoming \'Scottish Flat Season Finale\' race next Monday, 16th October at Musselburgh Racecourse (Edinburgh). <br> Ms Waterstone and Ms Fiammetta are highly respected tipsters amongst the horse racing elites in the UK and Italy. Both have achieved an outstanding level of performance that marks them as the very best in the game. They currently stand undefeated, having had an unbeatable strike of consecutive wins since 2021. We are truly honoured to have received information from Ms Waterstone and Ms Fiammetta on the 4 most popular horses running at Musselburgh in October. Click \'NEXT\' to continue.'
      ],
      show_clickable_nav: true
    }

    // play four audios, and let people answer once the last audio has finished playing. NB all responses are in survey form in javascript and the code is that they can edit their old bets as they listen to new descriptions
    // we have modified the AudioButtonResponse by combining it with the SurveyHtlmForm 

    var bet = {
        type: jsPsychAudioSurveyInputResponse,
        stimulus: function(){
            for(i in descriptions){
              console.log(descriptions)
              console.log(descriptions[i])
              return descriptions[i]
            }
        }, 
        html: `
            <div class="row">
              <div class='column'>
                <img src="`+ horses[0] +`.jpg"/>
                <img src="`+ horses[1] +`.jpg"/>
                <p> Place your bet on `+ horses[0] +` <input name="`+ horses[0] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[1] +`<input name="`+ horses[1] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
              <div class='column'>
                <img src="`+ horses[2] +`.jpg"/>
                <img src="`+ horses[3] +`.jpg"/>
                <p> Place your bet on `+ horses[2] +` <input name="`+ horses[2] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[3] +`<input name="`+ horses[3] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
            </div>`,
        response_allowed_while_playing: false,
        on_finish: function(data) {
          tot = 0
          tot += parseFloat(data.response.apocalypse);
          tot += parseFloat(data.response.blackblade);
          tot += parseFloat(data.response.silversky);
          tot += parseFloat(data.response.firewalker);
          console.log(tot)
          }
    }

    // If participants bet more than 100 pounds, ask them again until their bet is lower than 100. In this rounds, they cannot listen to the audio.

    var if_feedback = {
      type: jsPsychSurveyHtmlForm,
      preamble: function(){
        var horse0_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[0]];
        var horse1_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[1]];
        var horse2_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[2]];
        var horse3_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[3]];
        var text = '<p> You bet more than your allocated 100 pounds. Please, re-distribute your bets. You allocated ' + horse0_bet + ' on ' + horses[0] + 
          ', ' + horse1_bet +' on ' + horses[1] +', '+ horse2_bet +' on ' + horses[2] + ' and ' + horse3_bet +' on ' + horses[3] + '.</p>'
        return text
      },
      html: `
            <div class="row">
              <div class='column'>
                <img src="`+ horses[0] +`.jpg"/>
                <img src="`+ horses[1] +`.jpg"/>
                <p> Place your bet on `+ horses[0] +` <input name="`+ horses[0] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[1] +`<input name="`+ horses[1] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
              <div class='column'>
                <img src="`+ horses[2] +`.jpg"/>
                <img src="`+ horses[3] +`.jpg"/>
                <p> Place your bet on `+ horses[2] +` <input name="`+ horses[2] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[3] +`<input name="`+ horses[3] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
            </div>`,
        on_finish: function(data) {
          tot = 0
          tot += parseFloat(data.response.apocalypse);
          tot += parseFloat(data.response.blackblade);
          tot += parseFloat(data.response.silversky);
          tot += parseFloat(data.response.firewalker);
          console.log(tot)
          }
    }

    var if_node = {
      timeline: [if_feedback],
      conditional_function: function() {
        if(tot < 101){
          return false
        } else {
          return true
        }
      }
    }

    var loop_feedback = {
      timeline: [if_feedback],
      loop_function: function() {
        if(tot < 101){
          return false
        } else {
          return true
        }
      }
    }



    jsPsych.run([welcome_screen, check_headphones, bet, if_node, loop_feedback]);
  </script>
</html>