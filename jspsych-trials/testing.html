<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey@0.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.2"></script>
    <script src="./create-new-plugin/plugin-audio-survey-input-response.js"></script>
    <script src="./dist/plugin-instructions.js"></script>

    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@0.2.1/css/survey.css">
  </head>
  <body></body>
  <script>
    /* initialize jsPsych */
    var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    var timeline = [];
    
    // need this for the time being until we include all consent forms etc.
    var before_audio = {
        type: jsPsychHtmlButtonResponse,
        stimulus: 'Click to start',
        choices: ['OK']
    }

    // we will use this to randomly put the pictures given the group

    var horses = ['apocalypse', 'firewalker', 'blackblade', 'silversky'];
    var descriptions = ["critical_apocalypse_native_disfluent.mp3","critical_firewalker_nonnative_disfluent.mp3"];

    function shuffle(array) {
        let currentIndex = array.length,  randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex > 0) {

          // Pick a remaining element.
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          // And swap it with the current element.
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
        }

        return array;
    }

    shuffle(horses);
    shuffle(descriptions);
    


    // play four audios, and let people answer once the last audio has finished playing. NB all responses are in survey form in javascript and the code is that they can edit their old bets as they listen to new descriptions
    // we have modified the AudioButtonResponse by combining it with the SurveyHtlmForm 

    
    var bet = {
        type: jsPsychSurveyHtmlForm, 
        html: `
            <div class="row">
              <div class='column'>
                <img src="`+ horses[0] +`.jpg"/>
                <img src="`+ horses[1] +`.jpg"/>
                <p> Place your bet on `+ horses[0] +` <input name="`+ horses[0] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[1] +`<input name="`+ horses[1] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
              <div class='column'>
                <img src="`+ horses[2] +`.jpg"/>
                <img src="`+ horses[3] +`.jpg"/>
                <p> Place your bet on `+ horses[2] +` <input name="`+ horses[2] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[3] +`<input name="`+ horses[3] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
            </div>`,
        response_allowed_while_playing: false,
        on_finish: function(data) {
          tot = 0
          tot += parseFloat(data.response.apocalypse);
          tot += parseFloat(data.response.blackblade);
          tot += parseFloat(data.response.silversky);
          tot += parseFloat(data.response.firewalker);
          console.log(tot);
          jsPsych.data.addProperties({first_bet: tot});
          jsPsych.data.addProperties({fix_bet: 0});
          data;
          }
    }

    // If participants bet more than 100 pounds, ask them again until their bet is lower than 100. In this rounds, they cannot listen to the audio.

    var if_feedback = {
      type: jsPsychSurveyHtmlForm,
      preamble: function(){
        var horse0_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[0]];
        var horse1_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[1]];
        var horse2_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[2]];
        var horse3_bet = jsPsych.data.getLastTrialData().trials[0].response[horses[3]];
        var text = '<p> You bet more than your allocated 100 pounds. Please, re-distribute your bets. You allocated ' + horse0_bet + ' on ' + horses[0] + 
          ', ' + horse1_bet +' on ' + horses[1] +', '+ horse2_bet +' on ' + horses[2] + ' and ' + horse3_bet +' on ' + horses[3] + '.</p>'
        return text
      },
      html: `
            <div class="row">
              <div class='column'>
                <img src="`+ horses[0] +`.jpg"/>
                <img src="`+ horses[1] +`.jpg"/>
                <p> Place your bet on `+ horses[0] +` <input name="`+ horses[0] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[1] +`<input name="`+ horses[1] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
              <div class='column'>
                <img src="`+ horses[2] +`.jpg"/>
                <img src="`+ horses[3] +`.jpg"/>
                <p> Place your bet on `+ horses[2] +` <input name="`+ horses[2] +`" type="number" required max="100" step=".01" min="0" id="bet"/>
                  Place your bet on `+ horses[3] +`<input name="`+ horses[3] +`" type="number" required max="100" step=".01" min="0" id="bet"/></p>
              </div>
            </div>`,
        on_finish: function(data) {
          tot = 0
          tot += parseFloat(data.response.apocalypse);
          tot += parseFloat(data.response.blackblade);
          tot += parseFloat(data.response.silversky);
          tot += parseFloat(data.response.firewalker);
          console.log(tot)
          jsPsych.data.addProperties({fix_bet: tot});
          jsPsych.data.addProperties({first_bet: 0});
          }
    }

    // var if_node = {
    //   timeline: [if_feedback],
    //   conditional_function: function() {
    //     if(jsPsych.data.getLastTrialData().trials[0].first_bet < 101){
    //       return false
    //     } else {
    //       return true
    //     }
    //   }
    // }

    var loop_feedback = {
      timeline: [if_feedback],
      loop_function: function() {
        if(jsPsych.data.getLastTrialData().trials[0].fix_bet < 101 && jsPsych.data.getLastTrialData().trials[0].first_bet < 101){
          return false
        } else {
          return true
        }
      }
    };

    var loop_conditional_feedback = {
      timeline: [loop_feedback],
      conditional_function: function() {
        if(jsPsych.data.getLastTrialData().trials[0].fix_bet < 101 && jsPsych.data.getLastTrialData().trials[0].first_bet < 101){
          return false
        } else {
          return true
        }
      }
    };



    jsPsych.run([before_audio, bet, loop_conditional_feedback]);
  </script>
</html>